name: Build Installers (macOS & Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Override version (defaults to tag sans 'v' or 0.0.0-dev)"
        required: false
        default: ""

jobs:
  build:
    name: Build & Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            qt-arch: clang_64
          - os: windows-2022
            qt-arch: win64_msvc2022_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.9.2
          arch: ${{ matrix.qt-arch }}
          cache: true
          aqtversion: "==3.*"

      - name: Install CMake & Ninja
        uses: lukka/get-cmake@v3

      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        run: choco install ninja --no-progress

      - name: Compute VERSION
        id: ver
        shell: bash
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          ver=""
          if [[ -n "${INPUT_VERSION}" ]]; then
            ver="${INPUT_VERSION}"
          elif [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" == v* ]]; then
            ver="${GITHUB_REF_NAME#v}"
          else
            ver="0.0.0-dev+${GITHUB_RUN_NUMBER}"
          fi
          echo "VERSION=$ver" | tee -a "$GITHUB_ENV"
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      # ---------- Configure & Build ----------
      - name: Configure (Release)
        shell: bash
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${QT_ROOT_DIR}"

      - name: Build (Release)
        shell: bash
        run: cmake --build build --parallel

      # ---------- macOS packaging ----------
      - name: Package macOS (.dmg)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euxo pipefail
          APP_NAME="liquidssh"                                   # <- change if your target name differs
          APP_BUNDLE="build/${APP_NAME}.app"
          test -d "$APP_BUNDLE" || (echo "Missing $APP_BUNDLE"; ls -la build; exit 1)

          # Bundle Qt frameworks & plugins
          macdeployqt "$APP_BUNDLE" -verbose=2

          # Optional: codesign and notarize here (can add later)

          brew install create-dmg
          mkdir -p dist
          DMG_NAME="LiquidSSH-${VERSION}-macOS.dmg"
          create-dmg --overwrite --volname "LiquidSSH ${VERSION}" --app-drop-link 425 200 "$DMG_NAME" "$APP_BUNDLE"
          mv "$DMG_NAME" dist/

      # ---------- Windows packaging ----------
      - name: Install NSIS
        if: runner.os == 'Windows'
        run: choco install nsis --no-progress

      - name: Deploy Qt runtime (windeployqt)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ExeName = "liquidssh.exe"  # <- change if your target name differs
          $BuiltExe = Join-Path "build" $ExeName
          if (!(Test-Path $BuiltExe)) {
            $Candidate = Join-Path (Join-Path "build" "Release") $ExeName
            if (Test-Path $Candidate) { $BuiltExe = $Candidate } else {
              Write-Host "Available files:"
              Get-ChildItem -Recurse build | Select-Object -Expand FullName
              throw "Could not find built exe ($ExeName)"
            }
          }

          New-Item -ItemType Directory -Path "package" -Force | Out-Null
          Copy-Item $BuiltExe package/
          windeployqt --verbose 2 --dir package "package\$ExeName"

      - name: Create NSIS installer (.exe)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $Version = "${{ env.VERSION }}"
          $ProductName = "LiquidSSH"
          $ExeName = "liquidssh.exe"
          $OutDir = "dist"
          New-Item -ItemType Directory -Path $OutDir -Force | Out-Null

          $Nsi = @"
          !define PRODUCT_NAME "$ProductName"
          !define PRODUCT_VERSION "$Version"
          !define EXE_NAME "$ExeName"
          !define INSTALL_DIR "\$PROGRAMFILES64\\$ProductName"

          SetCompressor /SOLID lzma
          Unicode true
          RequestExecutionLevel admin
          Name "\${PRODUCT_NAME} \${PRODUCT_VERSION}"
          OutFile "$OutDir\\${ProductName}-${Version}-win64-setup.exe"
          InstallDir "\${INSTALL_DIR}"

          Page directory
          Page instfiles
          UninstPage uninstConfirm
          UninstPage instfiles

          Section "Install"
            SetOutPath "\${INSTALL_DIR}"
            File /r "package\\*.*"
            CreateShortCut "$SMPROGRAMS\\${ProductName}.lnk" "\${INSTALL_DIR}\\\${EXE_NAME}"
            CreateShortCut "$DESKTOP\\${ProductName}.lnk" "\${INSTALL_DIR}\\\${EXE_NAME}"
            WriteUninstaller "\${INSTALL_DIR}\\Uninstall.exe"
          SectionEnd

          Section "Uninstall"
            Delete "$SMPROGRAMS\\${ProductName}.lnk"
            Delete "$DESKTOP\\${ProductName}.lnk"
            RMDir /r "\${INSTALL_DIR}"
          SectionEnd
  "@
  Set-Content -Path installer.nsi -Value $Nsi -Encoding UTF8
  & makensis installer.nsi

# ---------- Upload artifacts ----------
- name: Upload macOS DMG
  if: runner.os == 'macOS'
  uses: actions/upload-artifact@v4
  with:
    name: LiquidSSH-macOS
    path: dist/*.dmg

- name: Upload Windows Installer
  if: runner.os == 'Windows'
  uses: actions/upload-artifact@v4
  with:
    name: LiquidSSH-Windows
    path: dist/*.exe
